@page "/"
@rendermode InteractiveServer
@using FactoryBridgeDashboard.Services
@inject ModbusService LegacyService
@inject HistorianService Historian
@inject AlertService Alerter
@implements IDisposable

<PageTitle>Factory Dashboard</PageTitle>

<div style="background-color: #1a1a1a; color: white; padding: 20px; text-align: center; font-family: sans-serif;">
    <h1>🏭 FactoryBridge Monitor</h1>
    <p>Live Multi-Variable Telemetry</p>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 40px 0;">
        
        <div style="background-color: #222; padding: 20px; border-radius: 10px; border: 1px solid #444;">
            <h4 style="color: #aaa;">Turbine Speed</h4>
            <h1 style="font-size: 50px; color: @SpeedColor; font-family: monospace;">@CurrentSpeed.ToString("N0")</h1>
            <p>RPM</p>
        </div>

        <div style="background-color: #222; padding: 20px; border-radius: 10px; border: 1px solid #444;">
            <h4 style="color: #aaa;">Bearing Temp</h4>
            <h1 style="font-size: 50px; color: @(CurrentTemp > 90 ? "#ff4444" : "#00aaff"); font-family: monospace;">
                @CurrentTemp.ToString("N0")
            </h1>
            <p>°Celsius</p>
        </div>

        <div style="background-color: #222; padding: 20px; border-radius: 10px; border: 1px solid #444;">
            <h4 style="color: #aaa;">Active Power</h4>
            <h1 style="font-size: 50px; color: #ffaa00; font-family: monospace;">
                @CurrentPower.ToString("N0")
            </h1>
            <p>Kilowatts</p>
        </div>
    </div>

    <div style="text-align: left; background-color: #000; padding: 15px; height: 150px; overflow-y: auto; font-family: monospace; border: 1px solid #333;">
        <h4 style="color: #888; border-bottom: 1px solid #333; padding-bottom: 5px;">🛑 Event Log</h4>
        @foreach (var log in EventLog)
        {
            <div style="color: @(log.Contains("CRITICAL") ? "#ff4444" : "#00ff00");">@log</div>
        }
    </div>
</div>

@code {
    private double CurrentSpeed = 0;
    private double CurrentTemp = 0;
    private double CurrentPower = 0;
    private string SpeedColor = "#fff";
    
    private List<string> EventLog = new List<string>();

    protected override void OnInitialized()
    {
        // We only LISTEN. We don't save anymore.
        LegacyService.OnValueUpdated += UpdateUI;
    }

    private async void UpdateUI(TurbineData data)
    {
        await InvokeAsync(() =>
        {
            // 1. Update Gauges
            CurrentSpeed = data.Speed;
            CurrentTemp = data.Temperature;
            CurrentPower = data.Power;
            SpeedColor = CurrentSpeed > 2400 ? "#ff4444" : "#00ff00";

            // 2. Update Log (Visual Only)
            if (data.Speed > 2400 || data.Temperature > 90)
            {
                string msg = $"[{DateTime.Now:HH:mm:ss}] ALERT: Speed {data.Speed} | Temp {data.Temperature}";
                // Prevent duplicate logs (simple check)
                if (EventLog.Count == 0 || !EventLog[0].StartsWith(msg.Substring(0, 15))) 
                {
                    EventLog.Insert(0, msg);
                }
            }
            if(EventLog.Count > 5) EventLog.RemoveAt(5);

            StateHasChanged();
        });
    }

    public void Dispose()
    {
        LegacyService.OnValueUpdated -= UpdateUI;
    }
}